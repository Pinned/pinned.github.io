<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    <title>大罗说事 | </title>
    
<link rel="stylesheet" href="/css/reset.css">

    
<link rel="stylesheet" href="/css/style.css">

    
<link rel="stylesheet" href="/css/markdown.css">

    
<link rel="stylesheet" href="/css/fonts.css">

<meta name="generator" content="Hexo 6.3.0"></head>
    <body>
        <div class="paper">
            <div class="paper-main">
                
                    <div class="post-header">
    <p class="post-title">Android之Webview使用</p>
</div>
                
                <div class="post-main">

    
        <div class="post-meta">
            <a class='author' href="/">罗昭成</a> 2023年05月29日
        </div>
        <div class="post-md">
            <h3 id="Android之Webview使用"><a href="#Android之Webview使用" class="headerlink" title="Android之Webview使用"></a>Android之Webview使用</h3><p>HTML页面是一个非常重要的角色，不仅是在PC端，在移动端也是非常重要的。</p>
<p>今天使用Webview来显示一个H5页面，其中就有地图页面。如果你经常使用浏览器，<br>你会发现，浏览器在使用定位信息的时候，需要相关权限，当然，有好的提示用户是一个<br>必不可少的步骤。</p>
<p><strong>问题</strong></p>
<p>用Webview加载map的时候，使用地理位置，提示用户授权。</p>
<p><strong>解决办法</strong></p>
<p>先看代码：</p>
<pre><code class="java">@Override
public void onGeolocationPermissionsShowPrompt(
        final String origin,
        final GeolocationPermissions.Callback callback) &#123;
    DebugLog.d(TAG, &quot;[onGeolocationPermissionsShowPrompt]&quot;);
    showLocalRemidPopupWindow(origin, new GeoListener() &#123;
        @Override
        public void onRefused() &#123;
            callback.invoke(origin, false, false);
        &#125;

        @Override
        public void onSharedLocation() &#123;
            callback.invoke(origin, true, false);
        &#125;
    &#125;);
&#125;

private void showLocalRemidPopupWindow(final String title, final GeoListener callback) &#123;
    String saved = PreferencesUtil.getString(this, title, &quot;&quot;);
    if (!TextUtils.isEmpty(saved)) &#123;
        if (saved.equals(&quot;true&quot;))&#123;
            if (callback != null) &#123;
                callback.onSharedLocation();
            &#125;
        &#125; else if (saved.equals(&quot;false&quot;))&#123;
            if (callback != null)&#123;
                callback.onRefused();
            &#125;
        &#125;
        return;
    &#125;
    if (mGeoPopupWindow == null)&#123;
        View view = LayoutInflater.from(this).inflate(R.layout.geo_popup_window, null);
        this.mGeoTitleTv = (TextView) view.findViewById(R.id.geo_title);
        this.mGeoSaveCb = (CheckBox) view.findViewById(R.id.geo_save_share_preference);
        this.mRefusedBtn = (Button) view.findViewById(R.id.refused_btn);
        this.mShareLocationBtn = (Button) view.findViewById(R.id.share_btn);
        this.mGeoPopupWindow = new PopupWindow(view,
                LinearLayout.LayoutParams.WRAP_CONTENT,
                LinearLayout.LayoutParams.WRAP_CONTENT, false);
    &#125;
    this.mGeoTitleTv.setText(String.format(getString(R.string.geo_title), title));
    this.mGeoSaveCb.setChecked(true);
    this.mRefusedBtn.setOnClickListener(new View.OnClickListener() &#123;
        @Override
        public void onClick(View view) &#123;
            saveSharePrefrence(title, false);
            if (callback != null) &#123;
                callback.onRefused();
            &#125;
            mGeoPopupWindow.dismiss();
        &#125;
    &#125;);
    this.mShareLocationBtn.setOnClickListener(new View.OnClickListener() &#123;
        @Override
        public void onClick(View view) &#123;
            saveSharePrefrence(title, true);
            if (callback != null) &#123;
                callback.onSharedLocation();
            &#125;
            mGeoPopupWindow.dismiss();
        &#125;
    &#125;);
    this.mGeoPopupWindow.showAtLocation(mWebView, Gravity.BOTTOM, 0, 0);
&#125;
</code></pre>
<p>当浏览器在调用地理位置信息，webView就会触发<code>onGeolocationPermissionsShowPrompt</code>这个方法的调用。<br>那浏览器中是如何调用地理位置信息的呢？这里我也去查看了一点点资料，大概了解了一下，<br>代码如下：</p>
<pre><code class="javascript">//通过navigator.geolocation对象获取地理位置信息
//常用的navigator.geolocation对象有以下三种方法：
//获取当前地理位置
navigator.geolocation.getCurrentPosition(
        success_callback_function,
        error_callback_function,
        position_options)
//持续获取地理位置
navigator.geolocation.watchPosition(
        success_callback_function,
        error_callback_function,
        position_options)
//清除持续获取地理位置事件
navigator.geolocation.clearWatch(watch_position_id)  
</code></pre>
<p>当然仅仅是重写<code>onGeolocationPermissionsShowPrompt</code>这个方法是不行的。<br>还要对webSetting进入相关设置，具体内容，<a target="_blank" rel="noopener" href="https://github.com/Pinned/WebViewDemo">源码</a><br>中有写相关代码。</p>
<blockquote>
<p><strong>WebSettings常用方法</strong></p>
<p>setAllowFileAccess 启用或禁止WebView访问文件数据</p>
<p>setBlockNetworkImage 是否显示网络图像</p>
<p>setBuiltInZoomControls 设置是否支持缩放</p>
<p>setCacheMode 设置缓冲的模式</p>
<p>setDefaultFontSize 设置默认的字体大小</p>
<p>setDefaultTextEncodingName 设置在解码时使用的默认编码</p>
<p>setFixedFontFamily 设置固定使用的字体</p>
<p>setJavaSciptEnabled 设置是否支持Javascript</p>
<p>setLayoutAlgorithm 设置布局方式</p>
<p>setLightTouchEnabled 设置用鼠标激活被选项</p>
<p>setSupportZoom 设置是否支持变焦</p>
<p><strong>WebViewClient常用方法</strong></p>
<p>doUpdate VisitedHistory 更新历史记录</p>
<p>onFormResubmission 应用程序重新请求网页数据</p>
<p>onLoadResource 加载指定地址提供的资源</p>
<p>onPageFinished 网页加载完毕</p>
<p>onPageStarted 网页开始加载</p>
<p>onReceivedError 报告错误信息</p>
<p>onScaleChanged WebView发生改变</p>
<p>shouldOverrideUrlLoading 控制新的连接在当前WebView中打开</p>
<p><strong>WebChromeClient常用方法</strong></p>
<p>onCloseWindow 关闭WebView</p>
<p>onCreateWindow 创建WebView</p>
<p>onJsAlert 处理Javascript中的Alert对话框</p>
<p>onJsConfirm处理Javascript中的Confirm对话框</p>
<p>onJsPrompt处理Javascript中的Prompt对话框</p>
<p>onProgressChanged 加载进度条改变</p>
<p>onReceivedlcon 网页图标更改</p>
<p>onReceivedTitle 网页Title更改</p>
<p>onRequestFocus WebView显示焦点</p>
</blockquote>
<p><strong>最后结果</strong></p>
<p><img src="/../../../../assets/posts/img-2014-10-13/device-2014-10-13-200631.png" alt="result"></p>
<p><strong>参考资料</strong></p>
<ol>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/t12x3456/article/details/13769731">Android WebView常见问题及解决方案汇总</a></li>
<li><a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/5329662/android-webview-geolocation">android webview geolocation</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.csdn.net/eagelangel/article/details/8807723">利用HTML5开发Android</a></li>
<li><a target="_blank" rel="noopener" href="http://dev.wo.com.cn/docportal/doc_queryMdocDetail.action?mdoc.docindex=6130">Android WebView</a></li>
</ol>

        </div>

    

</div>
                <!-- 
                    <div class="post_pre_next">
    
        <div class="post-pre">
            <a href="/2023/05/29/2014-10-24-android%20Log%20useing/">上一篇: Android之使用Log打印日志</a>
        </div>
    
    
        <a href="/2023/05/29/2014-09-14-Ubuntu%20System%20Install/">下一篇: 
            安装Ubuntu单系统
        </a>
    
</div>


                 -->
                <div class="footer">
    <span>Copyright © 2023 大罗说事</span>
</div>

<!-- 
<link rel="stylesheet" href="/css/highlight.default.css">
 -->

<link rel="stylesheet" href="/css/atom-one-dark.css">


<link rel="stylesheet" href="/css/code-theme.css">


<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
    hljs.highlightAll();
</script>

            </div>
        </div>
    </body>
</html>