<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <link rel="alternate icon" type="image/png" href="/img/favicon.png">
    
        <title>Android Network security configuration </title>
        
<link rel="stylesheet" href="/css/toc.css">

    
    <style type="text/css" id="reset">@charset "utf-8";

*,
*::before,
*::after
{
    box-sizing: border-box;
}

body,
h1,
h2,
h3,
h4,
h5,
h6,
p,
figure,
blockquote,
dl,
dd
{
    margin: 0;
}

ul,
ol
{
    list-style: none;
}

ul
{
    padding-inline-start: 0;
}

html,
body
{
    scroll-behavior: smooth;
}

a:not([class])
{
    text-decoration-skip-ink: auto;
}

img,
picture
{
    width: auto;
    max-width: 100%;
    display: block;
}

input,
button,
textarea,
select
{
    font: inherit;
}

@media (prefers-reduced-motion: reduce)
{
    html:focus-within
    {
        scroll-behavior: auto;
    }
}</style>
    <style type="text/css" id="style">@charset "utf-8";

p {
    word-wrap: break-word;
    white-space: pre-wrap;
    text-align: justify;
}

body {
    font-family: "PingFang SC", BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serifhtml, body;
    font-size: 16px;
    line-height: 1.75;
    letter-spacing: 0.6px;
    color: #666;
    background: #F0F0F0;
}

a {
    text-decoration: none;
    color: #000;
}



@media screen and (max-width: 480px) {
    body {
        background: #fff;
    }

    .paper {
        padding: 4vw;
    }

    .paper-main {
        width: 100%;
        margin: 0 auto;
        padding: 30px 1vw 12px;
        background: #fff;
    }
}

@media screen and (min-width: 481px) {
    .paper {
        padding: 4vw;
    }

    .paper-main {
        width: 900px;
        margin: 0 auto;
        padding: 62px 3vw 24px;
        background: #fff;
        border-radius: 24px;
    }
}

.header {
    padding-bottom: 48px;
    margin-bottom: 48px;
    border-bottom: 1px solid #ccc;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: center;
}

.logo {
    font-size: 2rem;
    font-weight: 600;
    color: #000;
    margin-bottom: 16px;
    flex: 0 0 100%;
}

.nav {
    margin: 0 0 4px;
    flex: 0 0 100%;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: center;
}

.nav li {
    padding: 2px 0;
    margin-right: 24px;
}

.nav li:last-of-type {
    margin-right: 0;
}

.nav li a {
    color: #000;
    opacity: .6;
    transition: opacity ease-in-out .5s;
}

.nav li a:hover {
    opacity: 1;
    transition: opacity ease-in-out .5s;
}

.post-header {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-content: center;
}

.post-header .post-title {
    font-size: 1.375rem;
    display: flex;
    justify-content: center;
    font-weight: bold;
    line-height: 1;
}

.post-list {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-items: stretch;
}

.post {
    width: 100%;
    padding-bottom: 48px;
    margin-bottom: 48px;
    border-bottom: 1px dashed #ddd;
}

.post-title {
    display: inline-block;
    font-size: 1.6rem;
    font-weight: 600;
    line-height: 1.5;
    margin-bottom: 12px;
    color: #000;
    /*transition: color ease-in-out .5s;*/
}

.post-title:hover {
    color: #04077e;
    transition: color ease-in-out .5s;
}

.post-except {
    word-break: break-all;
    margin-bottom: 12px;
    text-align: justify;
}

.read-more {
    padding: 0 4px;
    color: #04077e;
}

.read-more:before,
.read-more:after {
    display: inline-block;
    transition: transform ease-in-out .5s;
}

.read-more:before {
    content: "{ ";
}

.read-more:after {
    content: " }";
}

.read-more:hover:before {
    transform: translateX(-4px);
    transition: transform ease-in-out .25s;
}

.read-more:hover:after {
    transform: translateX(4px);
    transition: transform ease-in-out .25s;
}

.post-date {
    font-size: 0.875rem;
    color: #aaa;
}

.paginator {
    font-size: 0.875rem;
    width: 100%;
    margin: 0 auto 24px;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: space-evenly;
    align-items: center;
}

.paginator * {
    display: block;
    padding: 8px 16px;
    border-radius: 18px;
    background: #fff;
    border: 1px solid #eee;
}

.paginator .space {
    display: block;
    padding: 8px 16px;
    border-radius: 18px;
    background: #fff;
    border: none;
}

.paginator a {
    margin: 4px;
    color: #666;
    transition: color ease-in-out .5s;
}

.paginator a:hover {
    color: #04077e;
    transition: color ease-in-out .5s;
}

.paginator .current {
    color: #04077e;
    border: 1px solid #04077e;
}

.footer {
    padding: 24px 0;
    font-size: 0.875rem;
    color: #aaa;
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: flex-start;
    align-content: center;
}

.footer span {
    text-align: center;
    margin-bottom: 8px;
}

.footer a {
    color: #aaa;
    transition: color ease-in-out .5s;
}

.footer a:hover {
    color: #04077e;
    transition: color ease-in-out .5s;
}

.post-main {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: flex-start;
    align-items: center;
    margin-bottom: 24px;
}

.post-main-title {
    flex: 0 0 100%;
    margin-bottom: 12px;
    font-size: 1.6rem;
    font-weight: 600;
    line-height: 1.5;
    color: #000;
}

.post-meta {
    font-size: 0.875rem;
    color: #aaa;
    flex: 0 0 100%;
    margin-bottom: 32px;
}

.author {
    color: #576b95;
}

.archive {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
    justify-content: space-between;
    align-content: normal;
}

.archive li {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    justify-content: flex-start;
    align-content: center;
    padding: 12px 0;
}

.archive li:nth-child(odd) {
    background: #fafafa;
}

.archive li:nth-child(even) {
    background: #fff;
}

.archive li span {
    width: 108px;
    color: #666;
}

.archive-main {
    flex: 0 1 calc(100% - 108px);
}

.archive-title {
    color: #000;
    /*transition: color ease-in-out .5s;*/
}

.archive-title:hover {
    color: #04077e;
    transition: color ease-in-out .5s;
}

.post-image-caption {
    margin-top: 5px;
    text-align: center;
    color: #888;
    font-size: 0.85rem;
    display: block;
}

#clipboardbtn {
    cursor: pointer;
}

#bing-bg {
    width: 100%;
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
    filter: blur(10px);
    object-fit: cover;
  }
#go-top {
    cursor: pointer;
}

#beautiful {
    font-family: "PingFang SC", BlinkMacSystemFont, Roboto, "Helvetica Neue", sans-serifhtml, body;
    font-size: 16px;
    line-height: 1.75;
    letter-spacing: 0.6px;
}</style>
    <style type="text/css" id="markdown">@charset "utf-8";

#copy-post-content,
#beautiful,
.post-md
{
    width: 100%;
    letter-spacing: 0;
}

.post-md h1,
.post-md h2,
.post-md h3,
.post-md h4,
.post-md h5,
.post-md h6
{
    color: #000;
}
/* 一级标题 */
.post-md h1  {
    display:block;
    border-bottom: 4px solid rgb(33, 33, 34);
    font-size: 1rem;
}
  
/* 一级标题内容 */
.post-md h1  .content {
    display: flex;
    color: rgb(33, 33, 34);
    font-size: 1rem;
}
  
  
/* 一级标题后缀 */
.post-md h1  .suffix {
    display: flex;
    box-sizing: border-box;
    width: 20px;
    height: 10px;
    border-top-left-radius: 20px;
    border-top-right-radius: 20px;
    background: RGBA(33, 33, 34, .5);
    color: rgb(255, 255, 255);
    font-size: 16px;
    letter-spacing: 0.544px;
    justify-content: flex-end;
    box-sizing: border-box !important;
    overflow-wrap: break-word !important;
    float: right;
    margin-top: -10px;
}

/* 二级标题 */
.post-md h2 {
    margin: 10px auto;
    height: 40px;
    background-color: rgb(251, 251, 251);
    border-bottom: 1px solid rgb(246, 246, 246);
    box-sizing: border-box;
    font-size: 1rem;
}

/* 二级标题内容 */
.post-md h2 .content {
    display: inline-block;
    width: auto;
    height: 40px;
    background-color: rgb(33, 33, 34);
    border-bottom-right-radius:100px;
    color: rgb(255, 255, 255);
    padding-right: 30px;
    padding-left: 20px;
    font-size: 1rem;
    line-height: 40px;
}

/* 三级标题 */
.post-md h3 {
    margin: 20px auto 5px;
    border-top: 1px solid rgb(221, 221, 221);
    box-sizing: border-box;
    font-size: 1rem;
}
  
/* 三级标题内容 */
.post-md h3 .content {
    margin-top: -1px;
    padding-top: 6px;
    padding-right: 5px;
    padding-left: 5px;
    font-size: 1rem;
    border-top: 2px solid rgb(33, 33, 34);
    display: inline-block;
    line-height: 1.1;
}
.post-md h4
{
    font-size: 1rem;
    line-height: 1.2;
    padding: 16px 0;
}
.post-md h5
{
    font-size: 0.83rem;
    line-height: 1.2;
    padding: 14px 0;
}
.post-md h6
{
    font-size: 0.67rem;
    line-height: 1.2;
    padding: 12px 0;
}
.post-md a
{
    color: #61aeee;
    box-shadow: 0 2px 0 #ccc;
    transition: color ease-in-out .65s, box-shadow ease-in-out .65s;
}
.post-md a:hover
{
    color: #04077e;
    box-shadow: 0 2px 0 #04077e;
    transition: color ease-in-out .65s, box-shadow ease-in-out .65s;
}
.post-md strong
{
    font-weight: 700;
}
.post-md em
{
    font-style: italic;
}
.post-md kbd
{
    padding: 2px 4px;
    border-radius: 2px;
    background: #eee;
    border: 1px solid #ddd;
}
.post-md ol
{
    list-style: decimal;
    padding-left: 24px;
}
.post-md ul
{
    list-style: disc;
    padding-left: 24px;
}
.post-md img
{
    border-radius: 4px;
}
.post-md hr
{
    border: none;
    height: 1px;
    background: #ccc;
    margin: 24px 0;
}

.post-md p,
.post-md blockquote
{
    width: 100%;
    padding: 7px 0;
}
.post-md blockquote
{
    border-left: 2px solid #ddd;
    padding-left: 12px;
    word-wrap: break-word;
}

.post-md .video-container
{
    background: #000;
    border-radius: 4px;
    overflow: hidden;
}
.post-md iframe,
.post-md .video-container iframe
{
    width: 100%;
    height: 100vh;
    max-height: 360px;
    margin: 12px 0;
}

.post-md table {
    padding: 0;
    word-break: initial;
    width: 100%;
    page-break-inside: auto;
    border-spacing:0px;
    border: 0.5px solid #dfe2e5;
}
.post-md table tr {
    border: 0.5px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
.post-md table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
.post-md table th {
    font-weight: bold;
    border: 0.5px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
.post-md table td {
    border: 0.5px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
.post-md table th:first-child,
.post-md table td:first-child {
    margin-top: 0;
}
.post-md table th:last-child,
.post-md table td:last-child {
    margin-bottom: 0;
}


.inline-code
{
    border-radius: 4px;
    background:rgba(27,31,35,.05);
    padding: 2px 4px;
    color: rgb(0, 112, 96);
    font-size: 1rem;
    margin-left: 1px;
    margin-right: 1px;
}

.post-md .hljs-ln-numbers
{
    opacity: .5;
    padding-right: 12px;
}
</style>
<meta name="generator" content="Hexo 6.3.0"></head>
    <body>
        <img id="bing-bg" src="" referrerpolicy="no-referrer" />
        <div class="paper">
            
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4 id="go-top">目录</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Add%20a%20Network%20Security%20Configuration%20file"><span class="post-toc-text">Add a Network Security Configuration file</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Customize%20trusted%20CAs"><span class="post-toc-text">Customize trusted CAs</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Configure%20a%20custom%20CA"><span class="post-toc-text">Configure a custom CA</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Limit%20the%20set%20of%20trusted%20CAs"><span class="post-toc-text">Limit the set of trusted CAs</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Trust%20additional%20CAs"><span class="post-toc-text">Trust additional CAs</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Configure%20CAs%20for%20debugging"><span class="post-toc-text">Configure CAs for debugging</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Opt%20out%20of%20cleartext%20traffic"><span class="post-toc-text">Opt out of cleartext traffic</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Pin%20certificates"><span class="post-toc-text">Pin certificates</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Configuration%20inheritance%20behavior"><span class="post-toc-text">Configuration inheritance behavior</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Configuration%20file%20format"><span class="post-toc-text">Configuration file format</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cnetwork-security-config%3E"><span class="post-toc-text">&lt;network-security-config&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cbase-config%3E"><span class="post-toc-text">&lt;base-config&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cdomain-config%3E"><span class="post-toc-text">&lt;domain-config&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cdomain%3E"><span class="post-toc-text">&lt;domain&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cdebug-overrides%3E"><span class="post-toc-text">&lt;debug-overrides&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Ctrust-anchors%3E"><span class="post-toc-text">&lt;trust-anchors&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Ccertificates%3E"><span class="post-toc-text">&lt;certificates&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cpin-set%3E"><span class="post-toc-text">&lt;pin-set&gt;</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%3Cpin%3E"><span class="post-toc-text">&lt;pin&gt;</span></a></li></ol></li></ol>
        </nav>
    </aside>

            <div class="paper-main">
                
                    <div class="post-header">
    <p class="post-title">Android Network security configuration</p>
</div>
                
                <div class="post-main">

    
        <div class="post-meta">
            <a class='author' href="/">罗昭成</a> <span id="clipboardbtn">2019年08月10日</span>
        </div>
        <div id="copy-post-content">
            <section id="beautiful">
            <div class="post-md" >
                    <p>The Network Security Configuration feature lets apps customize their network security settings in a safe, declarative configuration file without modifying app code. These settings can be configured for specific domains and for a specific app. The key capabilities of this feature are as follows:</p>
<ul>
<li><strong>Custom trust anchors:</strong> Customize which Certificate Authorities (CA) are trusted for an app’s secure connections. For example, trusting particular self-signed certificates or restricting the set of public CAs that the app trusts.</li>
<li><strong>Debug-only overrides:</strong> Safely debug secure connections in an app without added risk to the installed base.</li>
<li><strong>Cleartext traffic opt-out:</strong> Protect apps from accidental usage of cleartext traffic.</li>
<li><strong>Certificate pinning:</strong> Restrict an app’s secure connection to particular certificates.</li>
</ul>
<h2 id="Add a Network Security Configuration file"><span class="prefix"></span><span class="content">Add a Network Security Configuration file</span><span class="suffix"></span></h2><p>The Network Security Configuration feature uses an XML file where you specify the settings for your app. You must include an entry in the manifest of your app to point to this file. The following code excerpt from a manifest demonstrates how to create this entry:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;manifest ... &gt;
    &lt;application android:networkSecurityConfig=&quot;@xml/network_security_config&quot;
                    ... &gt;
        ...
    &lt;/application&gt;
&lt;/manifest&gt;
</code></pre>
<h2 id="Customize trusted CAs"><span class="prefix"></span><span class="content">Customize trusted CAs</span><span class="suffix"></span></h2><p>An app may want to trust a custom set of CAs instead of the platform default. The most common reasons of this are:</p>
<ul>
<li>Connecting to a host with a custom certificate authority, such as a CA that is self-signed or is issued internally within a company.</li>
<li>Limiting the set of CAs to only the CAs you trust instead of every pre-installed CA.</li>
<li>Trusting additional CAs not included in the system.</li>
</ul>
<p>By default, secure connections (using protocols like TLS and HTTPS) from all apps trust the pre-installed system CAs, and apps targeting Android 6.0 (API level 23) and lower also trust the user-added CA store by default. An app can customize its own connections using <code class="inline-code">base-config</code> (for app-wide customization) or <code class="inline-code">domain-config</code> (for per-domain customization).</p>
<h3 id="Configure a custom CA"><span class="prefix"></span><span class="content">Configure a custom CA</span><span class="suffix"></span></h3><p>Assume you want to connect to your host which uses a self-signed SSL certificate or to a host whose SSL certificate is issued by a non-public CA which you trust, such as your company’s internal CA.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;domain-config&gt;
        &lt;domain includeSubdomains=&quot;true&quot;&gt;example.com&lt;/domain&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;@raw/my_ca&quot;/&gt;
        &lt;/trust-anchors&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;
</code></pre>
<p>Add the self-signed or non-public CA certificate, in PEM or DER format, to <code class="inline-code">res/raw/my_ca</code>.</p>
<h3 id="Limit the set of trusted CAs"><span class="prefix"></span><span class="content">Limit the set of trusted CAs</span><span class="suffix"></span></h3><p>An app that does not want to trust all CAs trusted by system can instead specify its own reduced set of CAs to trust. This protects the app from fraudulent certificates issued by any of the other CAs.</p>
<p>The configuration to limit the set of trusted CAs is similar to <a target="_blank" rel="noopener" href="https://developer.android.com/training/articles/security-config#ConfigCustom">trusting a custom CA</a> for a specific domain except that multiple CAs are provided in the resource.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;domain-config&gt;
        &lt;domain includeSubdomains=&quot;true&quot;&gt;secure.example.com&lt;/domain&gt;
        &lt;domain includeSubdomains=&quot;true&quot;&gt;cdn.example.com&lt;/domain&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;@raw/trusted_roots&quot;/&gt;
        &lt;/trust-anchors&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;
</code></pre>
<p>Add the trusted CAs, in PEM or DER format, to <code class="inline-code">res/raw/trusted_roots</code>. Note that if using PEM format the file must contain <em>only</em> PEM data and no extra text. You can also provide multiple <a target="_blank" rel="noopener" href="https://developer.android.com/training/articles/security-config#certificates">&#96;&#96;</a> elements instead of one.</p>
<h3 id="Trust additional CAs"><span class="prefix"></span><span class="content">Trust additional CAs</span><span class="suffix"></span></h3><p>An app may want to trust additional CAs not trusted by the system, this could be due to the system not yet including the CA or a CA that does not meet the requirements for inclusion into the Android system. An app can do this by specifying multiple certificate sources for a configuration.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;base-config&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;@raw/extracas&quot;/&gt;
            &lt;certificates src=&quot;system&quot;/&gt;
        &lt;/trust-anchors&gt;
    &lt;/base-config&gt;
&lt;/network-security-config&gt;
</code></pre>
<h2 id="Configure CAs for debugging"><span class="prefix"></span><span class="content">Configure CAs for debugging</span><span class="suffix"></span></h2><p>When debugging an app that connects over HTTPS, you may want to connect to a local development server, which does not have the SSL certificate for your production server. In order to support this without any modification to your app’s code, you can specify debug-only CAs, which are trusted <em>only</em> when <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/application-element.html#debug">android:debuggable</a> is <code class="inline-code">true</code>, by using <code class="inline-code">debug-overrides</code>. Normally, IDEs and build tools set this flag automatically for non-release builds.</p>
<p>This is safer than the usual conditional code because, as a security precaution, app stores do not accept apps which are marked debuggable.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;debug-overrides&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;@raw/debug_cas&quot;/&gt;
        &lt;/trust-anchors&gt;
    &lt;/debug-overrides&gt;
&lt;/network-security-config&gt;
</code></pre>
<h2 id="Opt out of cleartext traffic"><span class="prefix"></span><span class="content">Opt out of cleartext traffic</span><span class="suffix"></span></h2><blockquote>
<p> <strong>Note:</strong> The guidance in this section applies only to apps that target Android 8.1 (API level 27) or lower. Starting with Android 9 (API level 28), cleartext support is disabled by default.</p>
</blockquote>
<p>Applications intending to connect to destinations using only secure connections can opt-out of supporting cleartext (using the unencrypted HTTP protocol instead of HTTPS) to those destinations. This option helps prevent accidental regressions in apps due to changes in URLs provided by external sources such as backend servers. See <code class="inline-code">NetworkSecurityPolicy.isCleartextTrafficPermitted()</code> for more details.</p>
<p>For example, an app may want to ensure that all connections to <code class="inline-code">secure.example.com</code> are always done over HTTPS to protect sensitive traffic from hostile networks.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;domain-config cleartextTrafficPermitted=&quot;false&quot;&gt;
        &lt;domain includeSubdomains=&quot;true&quot;&gt;secure.example.com&lt;/domain&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;
</code></pre>
<h2 id="Pin certificates"><span class="prefix"></span><span class="content">Pin certificates</span><span class="suffix"></span></h2><p>Normally, an app trusts all pre-installed CAs. If any of these CAs were to issue a fraudulent certificate, the app would be at risk from a man-in-the-middle attack. Some apps choose to limit the set of certificates they accept by either limiting the set of CAs they trust or by certificate pinning.</p>
<p>Certificate pinning is done by providing a set of certificates by hash of the public key (<code class="inline-code">SubjectPublicKeyInfo</code> of the X.509 certificate). A certificate chain is then valid only if the certificate chain contains at least one of the pinned public keys.</p>
<p>Note that, when using certificate pinning, you should always include a backup key so that if you are forced to switch to new keys or change CAs (when pinning to a CA certificate or an intermediate of that CA), your app’s connectivity is unaffected. Otherwise, you must push out an update to the app to restore connectivity.</p>
<p>Additionally, it is possible to set an expiration time for pins after which pinning is not performed. This helps prevent connectivity issues in apps which have not been updated. However, setting an expiration time on pins may enable pinning bypass.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;domain-config&gt;
        &lt;domain includeSubdomains=&quot;true&quot;&gt;example.com&lt;/domain&gt;
        &lt;pin-set expiration=&quot;2018-01-01&quot;&gt;
            &lt;pin digest=&quot;SHA-256&quot;&gt;7HIpactkIAq2Y49orFOOQKurWxmmSFZhBCoQYcRhJ3Y=&lt;/pin&gt;
            &lt;!-- backup pin --&gt;
            &lt;pin digest=&quot;SHA-256&quot;&gt;fwza0LRMXouZHRC8Ei+4PyuldPDcf3UKgO/04cDM1oE=&lt;/pin&gt;
        &lt;/pin-set&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;
</code></pre>
<h2 id="Configuration inheritance behavior"><span class="prefix"></span><span class="content">Configuration inheritance behavior</span><span class="suffix"></span></h2><p>Values not set in a specific configuration are inherited. This behavior allows more complex configurations while keeping the configuration file readable.</p>
<p>If a value is not set in a specific entry, then the value from the more general entry is used. For example, values not set in a <code class="inline-code">domain-config</code> are taken from the parent <code class="inline-code">domain-config</code>, if nested, or from the <code class="inline-code">base-config</code> if not. Values not set in the <code class="inline-code">base-config</code> use the platform default values.</p>
<p>For example, consider where all connections to subdomains of <code class="inline-code">example.com</code> must use a custom set of CAs. Additonally, cleartext traffic to these domains is permitted <em>except</em> when connecting to <code class="inline-code">secure.example.com</code>. By nesting the configuration for <code class="inline-code">secure.example.com</code> inside the configuration for <code class="inline-code">example.com</code>, the <code class="inline-code">trust-anchors</code> does not need to be duplicated.</p>
<p><code class="inline-code">res/xml/network_security_config.xml</code>:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;domain-config&gt;
        &lt;domain includeSubdomains=&quot;true&quot;&gt;example.com&lt;/domain&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;@raw/my_ca&quot;/&gt;
        &lt;/trust-anchors&gt;
        &lt;domain-config cleartextTrafficPermitted=&quot;false&quot;&gt;
            &lt;domain includeSubdomains=&quot;true&quot;&gt;secure.example.com&lt;/domain&gt;
        &lt;/domain-config&gt;
    &lt;/domain-config&gt;
&lt;/network-security-config&gt;
</code></pre>
<h2 id="Configuration file format"><span class="prefix"></span><span class="content">Configuration file format</span><span class="suffix"></span></h2><p>The Network Security Configuration feature uses an XML file format. The overall structure of the file is shown in the following code sample:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;network-security-config&gt;
    &lt;base-config&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;...&quot;/&gt;
            ...
        &lt;/trust-anchors&gt;
    &lt;/base-config&gt;

    &lt;domain-config&gt;
        &lt;domain&gt;android.com&lt;/domain&gt;
        ...
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;...&quot;/&gt;
            ...
        &lt;/trust-anchors&gt;
        &lt;pin-set&gt;
            &lt;pin digest=&quot;...&quot;&gt;...&lt;/pin&gt;
            ...
        &lt;/pin-set&gt;
    &lt;/domain-config&gt;
    ...
    &lt;debug-overrides&gt;
        &lt;trust-anchors&gt;
            &lt;certificates src=&quot;...&quot;/&gt;
            ...
        &lt;/trust-anchors&gt;
    &lt;/debug-overrides&gt;
&lt;/network-security-config&gt;
</code></pre>
<p>The following sections describe the syntax and other details of the file format.</p>
<h3 id="&lt;network-security-config&gt;"><span class="prefix"></span><span class="content">&lt;network-security-config&gt;</span><span class="suffix"></span></h3><ul>
<li><p>can contain:</p>
<p>0 or 1 of <code class="inline-code">&lt;base-config&gt;</code> Any number of <code class="inline-code">&lt;domain-config&gt;</code> 0 or 1 of <code class="inline-code">&lt;debug-overrides&gt;</code></p>
</li>
</ul>
<h3 id="&lt;base-config&gt;"><span class="prefix"></span><span class="content">&lt;base-config&gt;</span><span class="suffix"></span></h3><ul>
<li>syntax:</li>
</ul>
<pre><code class="xml">&lt;base-config cleartextTrafficPermitted=[&quot;true&quot; | &quot;false&quot;]&gt;
    ...
&lt;/base-config&gt;
</code></pre>
<ul>
<li><p>can contain:</p>
<p><code class="inline-code">&lt;trust-anchors&gt;</code></p>
</li>
<li><p>description:</p>
<p>The default configuration used by all connections whose destination is not covered by a <a target="_blank" rel="noopener" href="https://developer.android.com/training/articles/security-config#domain-config"><code class="inline-code">domain-config</code></a>.Any values that are not set use the platform default values.The default configuration for apps targeting Android 9 (API level 28) and higher is as follows:<code class="inline-code">&lt;base-config cleartextTrafficPermitted=&quot;false&quot;&gt;    &lt;trust-anchors&gt;        &lt;certificates src=&quot;system&quot; /&gt;    &lt;/trust-anchors&gt;&lt;/base-config&gt;</code>The default configuration for apps targeting Android 7.0 (API level 24) to Android 8.1 (API level 27) is as follows:<code class="inline-code">&lt;base-config cleartextTrafficPermitted=&quot;true&quot;&gt;    &lt;trust-anchors&gt;        &lt;certificates src=&quot;system&quot; /&gt;    &lt;/trust-anchors&gt;&lt;/base-config&gt;</code>The default configuration for apps targeting Android 6.0 (API level 23) and lower is as follows:<code class="inline-code">&lt;base-config cleartextTrafficPermitted=&quot;true&quot;&gt;    &lt;trust-anchors&gt;        &lt;certificates src=&quot;system&quot; /&gt;        &lt;certificates src=&quot;user&quot; /&gt;    &lt;/trust-anchors&gt;&lt;/base-config&gt;</code></p>
</li>
</ul>
<h3 id="&lt;domain-config&gt;"><span class="prefix"></span><span class="content">&lt;domain-config&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;domain-config cleartextTrafficPermitted=[&quot;true&quot; | &quot;false&quot;]&gt;    ...&lt;/domain-config&gt;</code></p>
</li>
<li><p>Can Contain:</p>
<p>1 or more <code class="inline-code">&lt;domain&gt;</code>  0 or 1 <code class="inline-code">&lt;trust-anchors&gt;</code>  0 or 1 <code class="inline-code">&lt;pin-set&gt;</code>  Any number of nested <code class="inline-code">&lt;domain-config&gt;</code></p>
</li>
<li><p>Description</p>
<p>Configuration used for connections to specific destinations, as defined by the <code class="inline-code">domain</code> elements.Note that if multiple <code class="inline-code">domain-config</code> elements cover a destination, the configuration with the most specific (longest) matching domain rule is used.</p>
</li>
</ul>
<h3 id="&lt;domain&gt;"><span class="prefix"></span><span class="content">&lt;domain&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;domain includeSubdomains=[&quot;true&quot; | &quot;false&quot;]&gt;example.com&lt;/domain&gt;</code></p>
</li>
<li><p>Attributes:</p>
<p><code class="inline-code">includeSubdomains</code>If <code class="inline-code">&quot;true&quot;</code>, then this domain rule matches the domain and all subdomains, including subdomains of subdomains. Otherwise, the rule only applies to exact matches.</p>
</li>
<li><p>Description:</p>
</li>
</ul>
<h3 id="&lt;debug-overrides&gt;"><span class="prefix"></span><span class="content">&lt;debug-overrides&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;debug-overrides&gt;    ...&lt;/debug-overrides&gt;</code></p>
</li>
<li><p>Can Contain:</p>
<p>0 or 1 <code class="inline-code">&lt;trust-anchors&gt;</code></p>
</li>
<li><p>Description:</p>
<p>Overrides to be applied when <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/application-element.html#debug">android:debuggable</a> is <code class="inline-code">&quot;true&quot;</code>, which is normally the case for non-release builds generated by IDEs and build tools. Trust anchors specified in <code class="inline-code">debug-overrides</code> are added to all other configurations, and certificate pinning is not performed when the server’s certificate chain uses one of these debug-only trust anchors. If <a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/application-element.html#debug">android:debuggable</a> is <code class="inline-code">&quot;false&quot;</code>, then this section is completely ignored.</p>
</li>
</ul>
<h3 id="&lt;trust-anchors&gt;"><span class="prefix"></span><span class="content">&lt;trust-anchors&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;trust-anchors&gt;...&lt;/trust-anchors&gt;</code></p>
</li>
<li><p>Can Contain:</p>
<p>Any number of <code class="inline-code">&lt;certificates&gt;</code></p>
</li>
<li><p>Description:</p>
<p>Set of trust anchors for secure connections.</p>
</li>
</ul>
<h3 id="&lt;certificates&gt;"><span class="prefix"></span><span class="content">&lt;certificates&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;certificates src=[&quot;system&quot; | &quot;user&quot; | &quot;*raw resource*&quot;]              overridePins=[&quot;true&quot; | &quot;false&quot;] /&gt;</code></p>
</li>
<li><p>description:</p>
<p>Set of X.509 certificates for <code class="inline-code">trust-anchors</code> elements.</p>
</li>
<li><p>attributes:</p>
<p><code class="inline-code">src</code>The source of CA certificates. Each certificate can be one of the following:a raw resource ID pointing to a file containing X.509 certificates. Certificates must be encoded in DER or PEM format. In the case of PEM certificates, the file <em>must not</em> contain extra non-PEM data such as comments.<code class="inline-code">&quot;system&quot;</code> for the pre-installed system CA certificates<code class="inline-code">&quot;user&quot;</code> for user-added CA certificates<code class="inline-code">overridePins</code>Specifies if the CAs from this source bypass certificate pinning. If <code class="inline-code">&quot;true&quot;</code>, then pinning is not performed on certificate chains which are signed by one of the CAs from this source. This can be useful for debugging CAs or for testing man-in-the-middle attacks on your app’s secure traffic.Default is <code class="inline-code">&quot;false&quot;</code> unless specified in a <code class="inline-code">debug-overrides</code> element, in which case the default is <code class="inline-code">&quot;true&quot;</code>.</p>
</li>
</ul>
<h3 id="&lt;pin-set&gt;"><span class="prefix"></span><span class="content">&lt;pin-set&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;pin-set expiration=&quot;date&quot;&gt;...&lt;/pin-set&gt;</code></p>
</li>
<li><p>Can Contain:</p>
<p>Any number of <code class="inline-code">&lt;pin&gt;</code></p>
</li>
<li><p>Description:</p>
<p>A set of public key pins. For a secure connection to be trusted, one of the public keys in the chain of trust must be in the set of pins. See <code class="inline-code">&lt;pin&gt;</code> for the format of pins.</p>
</li>
<li><p>Attributes:</p>
<p><code class="inline-code">expiration</code>The date, in <code class="inline-code">yyyy-MM-dd</code> format, on which the pins expire, thus disabling pinning. If the attribute is not set, then the pins do not expire.Expiration helps prevent connectivity issues in apps which do not get updates to their pin set, such as when the user disables app updates.</p>
</li>
</ul>
<h3 id="&lt;pin&gt;"><span class="prefix"></span><span class="content">&lt;pin&gt;</span><span class="suffix"></span></h3><ul>
<li><p>syntax:</p>
<p><code class="inline-code">&lt;pin digest=[&quot;SHA-256&quot;]&gt;base64 encoded digest of X.509    SubjectPublicKeyInfo (SPKI)&lt;/pin&gt;</code></p>
</li>
<li><p>Attributes:</p>
<p><code class="inline-code">digest</code>The digest algorithm used to generate the pin. Currently, only <code class="inline-code">&quot;SHA-256&quot;</code> is supported.</p>
</li>
</ul>

                    <hr/>
            </div>
            </section>
        </div>
        <div style="margin: auto;">
            <div>
                <img src="https://moe-counter.glitch.me/get/@pinned_blog_Android Network security configuration?theme=moebooru" style="margin: 0 auto;" referrerpolicy="no-referrer">
            </div>
        </div>
        <input id="copy-input" style="position: absolute; left: -1000px; z-index: -1000;">

    

</div>
                <!-- 
                    <div class="post_pre_next">
    
        <div class="post-pre">
            <a href="/2019/08/10/Android-network-Configuration/">上一篇: Android 网络配置</a>
        </div>
    
    
        <a href="/2019/05/21/Android-camera-preview/">下一篇: 
            Android Camera Preview
        </a>
    
</div>


                 -->
                <div class="footer">
    <span>Copyright © 2023 大罗说事</span>
</div>

<!-- 
<link rel="stylesheet" href="/css/highlight.default.css">
 -->
<style type="text/css" id="atom-one-dark">pre code.hljs {
  display: block;
  overflow-x: auto;
  padding: 12px;
  font-size: 12px;
}
/*

Atom One Dark by Daniel Gamage
Original One Dark Syntax theme from https://github.com/atom/one-dark-syntax

base:    #282c34
mono-1:  #abb2bf
mono-2:  #818896
mono-3:  #5c6370
hue-1:   #56b6c2
hue-2:   #61aeee
hue-3:   #c678dd
hue-4:   #98c379
hue-5:   #e06c75
hue-5-2: #be5046
hue-6:   #d19a66
hue-6-2: #e6c07b

*/

.hljs {
  color: #abb2bf;
  background: #282c34;
}

.hljs-comment,
.hljs-quote {
  color: #5c6370;
  font-style: italic;
}

.hljs-doctag,
.hljs-keyword,
.hljs-formula {
  color: #c678dd;
}

.hljs-section,
.hljs-name,
.hljs-selector-tag,
.hljs-deletion,
.hljs-subst {
  color: #e06c75;
}

.hljs-literal {
  color: #56b6c2;
}

.hljs-string,
.hljs-regexp,
.hljs-addition,
.hljs-attribute,
.hljs-meta .hljs-string {
  color: #98c379;
}

.hljs-attr,
.hljs-variable,
.hljs-template-variable,
.hljs-type,
.hljs-selector-class,
.hljs-selector-attr,
.hljs-selector-pseudo,
.hljs-number {
  color: #d19a66;
}

.hljs-symbol,
.hljs-bullet,
.hljs-link,
.hljs-meta,
.hljs-selector-id,
.hljs-title {
  color: #61aeee;
}

.hljs-built_in,
.hljs-title.class_,
.hljs-class .hljs-title {
  color: #e6c07b;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}

.hljs-link {
  text-decoration: underline;
}

</style>
<style type="text/css" id="code-theme">pre::before {
    content: '';
    display: block;
    background: url("http://pinned.github.io/img/mac_style.svg");
    height: 30px;
    width: 100%;
    background-size: 40px;
    background-repeat: no-repeat;
    background-color: #282c34;
    margin-bottom: -7px;
    border-radius: 5px;
    background-position: 10px 10px;
}

pre code {
    border-radius: 5px;
}</style>

<script src="/js/highlight.min.js"></script>


<script src="/js/highlightjs-line-numbers.js"></script>


<script src="/js/juice.js"></script>


<script src="/js/copy_wechat.js"></script>


<script>
    hljs.highlightAll();
    // window.onload = function() {
    //     // 判断是否为手机浏览器
    //     const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    //     if (!isMobile) {
    //         fetch('https://pinned.github.io/bing-daily-picture/index.json')
    //             .then(response => response.text())
    //             .then(data => {
    //                 var result = JSON.parse(data)
    //                 var count = result.images.length
    //                 const index = Math.floor(Math.random() * count);
    //                 document.getElementById("bing-bg").src = "https://cn.bing.com" + result.images[index].url;
    //             }); // 返回的结果
    //     } 
    // }    
</script>

            </div>
        </div>
    </body>
</html>